<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    
    <!-- UPDATED: Added viewport-fit=cover to allow the app to fill the entire screen -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>DILLIGAF</title>

    <!-- ADDED: Meta tags for iOS full-screen app experience -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Nomad's">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/aarmax8/Nomads/b15a4394afade6bb543c1ece00102771641d1c82/Nicon5.png">
    
    <!-- End of added tags -->

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Cinzel:wght@400;700&family=IM+Fell+DW+Pica&family=Roboto+Condensed:wght@700&family=Rye&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        html, body {
            overscroll-behavior-y: contain;
            overflow: hidden; /* Prevent scrolling on the body */
            
        // --- Helper Functions ---
        
-       function throttle(func, limit) {
-         let lastFunc;
-         let lastRan;
-         return function(...args) {
-           const context = this;
-           if (!lastRan) {
-             func.apply(context, args);
-             lastRan = Date.now();
-           } else {
-             clearTimeout(lastFunc);
-             lastFunc = setTimeout(function() {
-               if ((Date.now() - lastRan) >= limit) {
-                 func.apply(context, args);
-                 lastRan = Date.now();
-               }
-             }, limit - (Date.now() - lastRan));
-           }
-         }
-       }
-
        function parseIngredientName(ingStr) {
            let name = ingStr.replace(/^[\d./\s-]+(oz|dashes|dash|garnish)\s*/i, '');
            const instructionalPhrases = [ 'Fill a tall glass with ', 'Fill with ', 'Top with ', 'Splash of ', 'Splash '];
            for (const phrase of instructionalPhrases) {
                if (name.toLowerCase().startsWith(phrase.toLowerCase())) {
                    name = name.substring(phrase.length);
                    const inIndex = name.toLowerCase().indexOf(' in a');
                    if (inIndex > -1) name = name.substring(0, inIndex);
                    break;
                }
            }
            const pureInstructions = ['serve on the rocks'];
            if(pureInstructions.includes(name.toLowerCase().trim())) return null;
            return name.trim();
        }

        /* REMOVED: closeFloatingMenu function */
        
        // --- END HELPER FUNCTIONS ---
 
+       let scrollTimeout; // Used for debouncing the scroll event
+
        document.addEventListener('DOMContentLoaded', () => {
            setupCocktailData();
            initializeFavorites();
            initializeBarStock();
            initializeFilterModal(); 
            applyAndRenderFilters(); 
            updateFilterMenuButtonState(); 
            
            // --- Splash Screen ---
            const splashScreen = document.getElementById('splash-screen');
            const splashSeenKey = 'nomads_splash_seen_v1';
            
            if (splashScreen) {
                if (sessionStorage.getItem(splashSeenKey) === 'true') {
                    splashScreen.style.transition = 'none'; 
                    splashScreen.classList.add('is-hidden');
                } else {
                    splashScreen.addEventListener('click', () => {
                        splashScreen.classList.add('is-hidden');
                        sessionStorage.setItem(splashSeenKey, 'true');
                    }, { once: true }); 
                }
            }

            // --- Menu Grid Events ---
            menuGrid.addEventListener('click', e => {
                const favoriteButton = e.target.closest('.favorite-btn');
                if (favoriteButton) {
                    e.stopPropagation(); 
                    const cardName = e.target.closest('.drink-card').dataset.name;
                    toggleFavorite(cardName, favoriteButton.dataset.type, favoriteButton);
                    return;
                }

                const cardInner = e.target.closest('.drink-card-inner');
                 if (cardInner) {
                      const card = cardInner.closest('.drink-card');
                      if(card && !card.dataset.isBarcode) {
                         card.classList.toggle('is-flipped');
                      }
                 }
            });
 
             // --- Active Card on Scroll ---
-            let scrollTimeout;
-            const throttledUpdateActiveCard = throttle(updateActiveCard, 150); 
-            menuGrid.addEventListener('scroll', () => {
-                clearTimeout(scrollTimeout);
-                throttledUpdateActiveCard(); 
+            // We use a "debounce" pattern here. The updateActiveCard function will
+            // only be called 150ms *after* the user has stopped scrolling.
+            // This prevents the "active" class change (and its box-shadow) 
+            // from interfering with the browser's scroll-snap behavior.
+            menuGrid.addEventListener('scroll', () => {
+                clearTimeout(scrollTimeout);
+                scrollTimeout = setTimeout(updateActiveCard, 150);
             });
             
             /* REMOVED: Old Floating Menu listeners */
                    modalElement.classList.add('hidden');
                }, 300); 
            }

            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal);
                    }
                });
            });

            // Favorites Modal Close & Item Click
            document.getElementById('close-favorites-btn')?.addEventListener('click', () => closeModal(favoritesModal));
            document.getElementById('favorites-list-container').addEventListener('click', (e) => {
                 const favoriteItem = e.target.closest('.favorite-item');
                 if (favoriteItem) {
                     const cardName = favoriteItem.dataset.name;
                     const cardEl = document.querySelector(`.drink-card[data-name="${cardName}"]`);
                     if (cardEl) {
                         if (favoriteItem.dataset.view === 'drink') {
                             cardEl.classList.remove('is-flipped');
                         }
                         highlightAndScrollToCard(cardEl);
                     }
                     closeModal(favoritesModal);
                 }
            });

            // Bar Stock Modal Close
            document.getElementById('close-stock-btn')?.addEventListener('click', () => closeModal(barStockModal));

            // Filter Modal Close & Actions
            document.getElementById('close-filter-btn')?.addEventListener('click', () => closeModal(filterModal));
            document.getElementById('apply-filters-btn')?.addEventListener('click', () => {
                applyAndRenderFilters();
                closeModal(filterModal);
            });
            document.getElementById('reset-filters-btn')?.addEventListener('click', () => {
                activeFilters = { category: 'all', spirit: null, ingredient: null, showFavoritesOnly: false };
                updatePillsFromState();
                applyAndRenderFilters();
            });
            
            // Filter Modal Content Interactions
            document.getElementById('filter-modal-content').addEventListener('click', (e) => {
                const pill = e.target.closest('.filter-pill');
                if (!pill) return;
                const categoryGroup = e.target.closest('#filter-group-category');
                const spiritGroup = e.target.closest('#filter-group-spirit');
                if (categoryGroup) {
                    activeFilters.category = pill.dataset.category;
                    categoryGroup.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('is-active'));
                    pill.classList.add('is-active');
                } else if (spiritGroup) {
                    const spirit = pill.dataset.spirit;
                    if (activeFilters.spirit === spirit) {
                        activeFilters.spirit = null;
                        pill.classList.remove('is-active');
                    } else {
                        activeFilters.spirit = spirit;
                        spiritGroup.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('is-active'));
                        pill.classList.add('is-active');
                    }
                }
            });
            document.getElementById('ingredient-filter-select')?.addEventListener('change', (e) => {
                 activeFilters.ingredient = e.target.value || null;
            });
            document.getElementById('favorites-filter-toggle')?.addEventListener('change', (e) => {
                activeFilters.showFavoritesOnly = e.target.checked;
            });


            // --- New Footer Button Listeners ---
            document.getElementById('footer-filters-btn')?.addEventListener('click', () => {
                updatePillsFromState(); 
                filterModal.classList.remove('hidden');
                setTimeout(() => filterModal.classList.remove('opacity-0'), 10);
            });
            
            document.getElementById('footer-favorites-btn')?.addEventListener('click', () => {
                renderFavoritesModal(); 
                favoritesModal.classList.remove('hidden');
                setTimeout(() => favoritesModal.classList.remove('opacity-0'), 10);
            });
            
            document.getElementById('footer-stock-btn')?.addEventListener('click', () => {
                renderBarStockModal(); // Render content before showing
                barStockModal.classList.remove('hidden');
                setTimeout(() => barStockModal.classList.remove('opacity-0'), 10);
            });

            // --- Footer Buttons (existing) ---
            if (randomDrinkBtn) {
                randomDrinkBtn.addEventListener('click', () => {
                    const allDrinkCards = document.querySelectorAll('.drink-card:not([data-is-barcode="true"])');
                    if (allDrinkCards.length === 0) return; 
                    const randomIndex = Math.floor(Math.random() * allDrinkCards.length);
                    const randomCard = allDrinkCards[randomIndex];
                    randomCard.classList.remove('is-flipped'); 
                    highlightAndScrollToCard(randomCard);
                });
            }
            
            const scrollPrevBtn = document.getElementById('scroll-prev-btn');
            if (scrollPrevBtn) {
                scrollPrevBtn.addEventListener('click', () => {
                    const cards = Array.from(menuGrid.querySelectorAll('.drink-card'));
                    if (cards.length === 0) return;
                    const activeCard = menuGrid.querySelector('.drink-card.is-active') || cards[0];
                    const activeIndex = cards.indexOf(activeCard);
                    const targetIndex = Math.max(0, activeIndex - 4); 
                    if (activeIndex !== targetIndex) {
                        cards[targetIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    }
                });
            }

            const scrollNextBtn = document.getElementById('scroll-next-btn');
            if (scrollNextBtn) {
                scrollNextBtn.addEventListener('click', () => {
                    const cards = Array.from(menuGrid.querySelectorAll('.drink-card'));
                    if (cards.length === 0) return;
                    const activeCard = menuGrid.querySelector('.drink-card.is-active') || cards[0];
                    const activeIndex = cards.indexOf(activeCard);
                    const targetIndex = Math.min(cards.length - 1, activeIndex + 4); 
                    if (activeIndex !== targetIndex) {
                        cards[targetIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    }
                });
            }
            
            const toggleViewBtnMain = document.getElementById('toggle-view-btn-main');
            const throttledToggle = throttle(() => {
                 setCardView(!isGlobalTarotView); 
            }, 300); 
            if (toggleViewBtnMain) {
                toggleViewBtnMain.addEventListener('click', throttledToggle);
            }

        }); // End DOMContentLoaded
 
    </script>
</body>
</html>















































