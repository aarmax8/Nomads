<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    
    <!-- UPDATED: Added viewport-fit=cover to allow the app to fill the entire screen -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>DILLIGAF</title>

    <!-- ADDED: Meta tags for iOS full-screen app experience -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Nomad's">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/aarmax8/Nomads/b15a4394afade6bb543c1ece00102771641d1c82/Nicon5.png">
    
    <!-- End of added tags -->

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Cinzel:wght@400;700&family=IM+Fell+DW+Pica&family=Roboto+Condensed:wght@700&family=Rye&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        html, body {
            overscroll-behavior-y: contain;
            overflow: hidden; /* Prevent scrolling on the body */
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #000;
        }

        #app-container {
            font-family: 'Cinzel', serif;
            color: #E0C9A6; /* Primary text color: parchment */
            background-color: #000;
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full viewport height */
            height: -webkit-fill-available; /* For iOS Safari */
        }
        
        main {
            flex-grow: 1; /* Allow main content to grow and fill space */
            position: relative; /* Needed for the menu grid */
            z-index: 1; 
            min-height: 0; /* ADDED: Ensure main content can shrink if needed */
        }

        #header-logo-container {
            position: relative;
            overflow: hidden; /* To contain the glint */
            min-height: 150px; /* MODIFIED: Was 200px, reduced to give more space to menu */
            padding-top: env(safe-area-inset-top);
        }

        #header-logo-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center 30%; /* Adjust as needed */
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        
        /* Barcode overlay style */
        .barcode-overlay {
            position: absolute;
            top: 10%;
            left: 10%;
            width: 80%;
            height: 80%;
            background-image: url('https://raw.githubusercontent.com/aarmax8/Nomads/5915ae46af9d547d456ba87aa624286b7aeb729a/barcode.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.1;
            z-index: 2;
            pointer-events: none;
        }

        /* Glint animation */
        .glint-overlay {
            position: absolute;
            top: 0;
            left: -150%; /* Start off-screen */
            width: 50%;
            height: 100%;
            background: linear-gradient(
                to right,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.2) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            transform: skewX(-25deg); /* Angle the glint */
            animation: glint 5s infinite 2s; /* name, duration, timing-function, delay */
            z-index: 3;
            pointer-events: none;
            opacity: 0.7;
        }

        @keyframes glint {
            0% { left: -150%; opacity: 0.3; }
            50% { left: 150%; opacity: 0.7; }
            100% { left: 150%; opacity: 0.7; } /* Hold off-screen */
        }

        /* --- Main Menu Grid --- */
        #menu-grid-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0; /* Fill the 'main' container */
            overflow-y: scroll; /* Allow vertical scrolling OF THE CONTAINER */
            -webkit-overflow-scrolling: touch;
            perspective: 1000px;
            
            /* ADDED: Scroll-snap properties */
            scroll-snap-type: y mandatory;
            
            /* Hide scrollbar */
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        #menu-grid-container::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }

        #menu-grid {
            display: grid;
            grid-template-columns: 1fr; /* Single column */
            gap: 5vh; /* Space between cards */
            padding: 5vh 0; /* Padding top and bottom */
            width: 100%;
        }

        .drink-card {
            width: 80vw;
            max-width: 400px;
            height: 70vh; /* Each card is a "page" */
            margin: 0 auto; /* Center the card */
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s, box-shadow 0.4s;
            transform-origin: center center;
            
            /* ADDED: Scroll-snap alignment */
            scroll-snap-align: center;
            
            /* Base card style */
            border: 2px solid #5a4a3a; /* Darker border */
            background-color: #1a1a1a; /* Dark card bg */
            border-radius: 15px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        /* Card flip */
        .drink-card.is-flipped {
            transform: rotateY(180deg);
        }

        .drink-card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            border-radius: 13px; /* Match outer radius */
            overflow: hidden; /* Clip inner content */
            background-color: #110e0a; /* Dark wood/leather bg */
        }

        .drink-card-front {
            /* Front face styles */
        }

        .drink-card-back {
            transform: rotateY(180deg);
        }
        
        /* --- Card Content --- */
        .card-image-container {
            height: 40%;
            position: relative;
            overflow: hidden;
        }
        .card-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.4s ease;
        }
        .drink-card:hover .card-image {
             transform: scale(1.05);
        }
        
        .card-content {
            padding: 1rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Scroll if content overflows */
            -webkit-overflow-scrolling: touch;
        }
        .card-content-back {
             padding: 1.5rem;
        }
        
        .card-title {
            font-family: 'Black Ops One', sans-serif;
            font-size: 1.75rem;
            color: #E0C9A6;
            text-shadow: 1px 1px 2px #000;
            margin-bottom: 0.5rem;
        }
        
        .card-hook {
            font-family: 'IM Fell DW Pica', serif;
            font-size: 1.1rem;
            font-style: italic;
            color: #b0a08a; /* Muted parchment */
            margin-bottom: 0.75rem;
            border-bottom: 1px dashed #5a4a3a;
            padding-bottom: 0.75rem;
        }
        
        .card-flavor-profile {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            line-height: 1.4;
            color: #c7b299;
            flex-grow: 1; /* Pushes button to bottom */
        }
        
        /* --- Back of Card --- */
        .card-back-title {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 700;
            font-size: 1.25rem;
            color: #E0C9A6;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }
        
        .card-recipe {
            list-style: none;
            padding-left: 0;
            margin-bottom: 1rem;
        }
        .card-recipe li {
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            color: #c7b299;
            margin-bottom: 0.5rem;
            padding-left: 1.5rem;
            position: relative;
        }
        .card-recipe li::before {
            content: 'â€¢';
            color: #8a7a6a; /* Muted bullet */
            font-size: 1.25rem;
            position: absolute;
            left: 0;
            top: -2px;
        }
        
        .card-story {
            font-family: 'IM Fell DW Pica', serif;
            font-size: 1rem;
            font-style: italic;
            color: #b0a08a;
            line-height: 1.5;
            border-top: 1px dashed #5a4a3a;
            padding-top: 1rem;
        }
        
        /* --- Favorite Button --- */
        .favorite-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.5);
            border: none;
            border-radius: 50%;
            color: #E0C9A6;
            font-size: 1.25rem;
            cursor: pointer;
            transition: color 0.2s, transform 0.2s;
        }
        .favorite-btn.is-favorite {
            color: #FFD700; /* Gold when favorited */
        }
        .favorite-btn:hover {
            transform: scale(1.1);
        }
        .favorite-btn.is-favorite .fa-star-o {
            display: none;
        }
        .favorite-btn:not(.is-favorite) .fa-star {
            display: none;
        }

        /* --- Footer --- */
        #footer {
            flex-shrink: 0; /* Prevent footer from shrinking */
            background-color: #0a0a0a;
            border-top: 1px solid #3a2a1a;
            padding: 0.5rem 1rem; /* Reduced padding */
            padding-bottom: calc(0.5rem + env(safe-area-inset-bottom)); /* Adjust for iOS home bar */
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 10;
            position: relative;
        }
        .footer-btn {
            background: none;
            border: none;
            color: #a08a7a; /* Muted icon color */
            font-size: 1.75rem; /* Larger icons */
            padding: 0.5rem;
            border-radius: 8px;
            transition: color 0.2s, background-color 0.2s;
        }
        .footer-btn:hover {
            color: #E0C9A6; /* Parchment on hover */
            background-color: #2a1a0a;
        }
        .footer-btn.is-active {
            color: #FFD700; /* Gold */
        }

        /* --- Active Card Highlight --- */
        .drink-card.is-active {
            box-shadow: 0 0 25px 5px rgba(255, 215, 0, 0.4); /* Gold glow */
        }

        /* --- Splash Screen --- */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            opacity: 1;
        }
        #splash-screen.is-hidden {
            opacity: 0;
            transform: scale(1.1);
            pointer-events: none;
        }
        #splash-logo {
            width: 80%;
            max-width: 400px;
            margin-bottom: 1rem;
        }
        #splash-text {
            font-family: 'Cinzel', serif;
            color: #E0C9A6;
            font-size: 1.25rem;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        /* --- Modals --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 900;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            background-color: #110e0a; /* Dark wood */
            border: 2px solid #5a4a3a;
            border-radius: 15px;
            width: 90vw;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #3a2a1a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title {
            font-family: 'Black Ops One', sans-serif;
            font-size: 1.5rem;
            color: #E0C9A6;
        }
        .modal-close-btn {
            background: none;
            border: none;
            color: #a08a7a;
            font-size: 1.75rem;
            transition: color 0.2s;
        }
        .modal-close-btn:hover {
            color: #E0C9A6;
        }
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #3a2a1a;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        .modal-btn {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            text-transform: uppercase;
            padding: 0.5rem 1.25rem;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .modal-btn.primary {
            background-color: #E0C9A6;
            color: #110e0a;
            border-color: #E0C9A6;
        }
        .modal-btn.primary:hover {
            background-color: #c7b299;
            border-color: #c7b299;
        }
        .modal-btn.secondary {
            background-color: transparent;
            color: #a08a7a;
            border-color: #5a4a3a;
        }
        .modal-btn.secondary:hover {
            background-color: #5a4a3a;
            color: #E0C9A6;
        }
        
        /* --- Bar Stock Modal --- */
        .stock-category {
            margin-bottom: 1.5rem;
        }
        .stock-category-title {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            color: #b0a08a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
            border-bottom: 1px dashed #5a4a3a;
            padding-bottom: 0.25rem;
        }
        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
        }
        .stock-item {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            color: #a08a7a;
            padding: 0.5rem 0.75rem;
            border: 1px solid #3a2a1a;
            border-radius: 6px;
            text-align: center;
            background-color: #221c15;
            transition: all 0.2s;
            cursor: pointer;
        }
        .stock-item.is-owned {
            color: #E0C9A6;
            background-color: #3a2a1a;
            border-color: #5a4a3a;
        }

        /* --- Favorites Modal --- */
        #favorites-list-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .favorite-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: #221c15;
            border: 1px solid #3a2a1a;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .favorite-item:hover {
            background-color: #3a2a1a;
        }
        .favorite-item-icon {
            font-size: 1.25rem;
            color: #8a7a6a;
            margin-right: 1rem;
        }
        .favorite-item-name {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            color: #E0C9A6;
            flex-grow: 1;
        }
        .favorite-item-view {
            font-family: 'IM Fell DW Pica', serif;
            font-size: 0.9rem;
            font-style: italic;
            color: #a08a7a;
        }
        #no-favorites-message {
            font-family: 'IM Fell DW Pica', serif;
            font-size: 1.1rem;
            font-style: italic;
            color: #a08a7a;
            text-align: center;
            padding: 2rem 0;
        }
        
        /* --- Filter Modal --- */
        .filter-group {
            margin-bottom: 1.5rem;
        }
        .filter-group-title {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            color: #b0a08a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
        }
        .filter-pill-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .filter-pill {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            color: #a08a7a;
            padding: 0.5rem 1rem;
            border: 1px solid #3a2a1a;
            border-radius: 20px;
            background-color: #221c15;
            transition: all 0.2s;
            cursor: pointer;
        }
        .filter-pill.is-active {
            color: #110e0a;
            background-color: #E0C9A6;
            border-color: #E0C9A6;
        }
        
        .filter-select, .filter-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 1rem;
        }
        .filter-select select {
            background-color: #221c15;
            border: 1px solid #3a2a1a;
            color: #E0C9A6;
            border-radius: 6px;
            padding: 0.5rem;
            font-family: 'Cinzel', serif;
            width: 60%;
        }
        
        /* Custom Checkbox for Toggle */
        .switch {
          position: relative;
          display: inline-block;
          width: 50px;
          height: 28px;
        }
        .switch input { 
          opacity: 0;
          width: 0;
          height: 0;
        }
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #3a2a1a;
          transition: .4s;
          border-radius: 28px;
        }
        .slider:before {
          position: absolute;
          content: "";
          height: 20px;
          width: 20px;
          left: 4px;
          bottom: 4px;
          background-color: #a08a7a;
          transition: .4s;
          border-radius: 50%;
        }
        input:checked + .slider {
          background-color: #E0C9A6;
        }
        input:checked + .slider:before {
          background-color: #110e0a;
          transform: translateX(22px);
        }
        
        /* --- Tarot Card Styles --- */
        .drink-card.tarot-view .drink-card-inner {
            border: 5px solid #E0C9A6;
            background: #110e0a;
            box-shadow: 0 0 10px #E0C9A6;
        }
        .drink-card.tarot-view .card-image-container {
            height: 65%; /* More image */
            border-bottom: 5px solid #E0C9A6;
            padding: 10px;
            background-color: #000;
        }
        .drink-card.tarot-view .card-image {
             border: 2px solid #5a4a3a;
        }
        .drink-card.tarot-view .card-content {
            padding: 1rem;
            height: 35%;
            justify-content: center; /* Center title */
            align-items: center;
        }
        .drink-card.tarot-view .card-title {
            font-size: 1.5rem; /* Smaller title */
            text-align: center;
        }
        /* Hide elements in Tarot view */
        .drink-card.tarot-view .card-hook,
        .drink-card.tarot-view .card-flavor-profile,
        .drink-card.tarot-view .favorite-btn {
            display: none;
        }

        /* --- Barcode Card --- */
        .barcode-card-face {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }
        #barcode-image {
            width: 80%;
            max-width: 300px;
            filter: invert(1) brightness(0.8);
            image-rendering: pixelated; /* Keep it sharp */
        }
        #barcode-text {
            font-family: 'IM Fell DW Pica', serif;
            font-size: 1.1rem;
            font-style: italic;
            color: #b0a08a;
            margin-top: 1.5rem;
            line-height: 1.6;
        }

        /* Utility */
        .hidden {
            display: none;
        }
        .opacity-0 {
            opacity: 0;
        }

    </style>
</head>
<body class="bg-black">

    <!-- Splash Screen -->
    <div id="splash-screen">
        <img id="splash-logo" src="https://raw.githubusercontent.com/aarmax8/Nomads/b15a4394afade6bb543c1ece00102771641d1c82/Nicon5.png" alt="Nomad's Logo">
        <div id="splash-text">Tap to Enter</div>
    </div>

    <!-- Main App Container -->
    <div id="app-container">

        <!-- Header -->
        <header id="header-logo-container">
            <img id="header-logo-image" src="https://raw.githubusercontent.com/aarmax8/Nomads/b15a4394afade6bb543c1ece00102771641d1c82/Nicon5.png" alt="Nomad's Logo">
            <div class="barcode-overlay"></div>
            <div class="glint-overlay"></div>
        </header>

        <!-- Main Content (Scrollable) -->
        <main>
            <div id="menu-grid-container">
                <div id="menu-grid">
                    <!-- Drink cards will be injected here by JavaScript -->
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer id="footer">
            <button id="footer-filters-btn" class="footer-btn">
                <i class="fa fa-filter"></i>
            </button>
            <button id="scroll-prev-btn" class="footer-btn">
                <i class="fa fa-angle-double-up"></i>
            </button>
            <button id="random-drink-btn" class="footer-btn">
                <i class="fa fa-random"></i>
            </button>
            <button id="scroll-next-btn" class="footer-btn">
                <i class="fa fa-angle-double-down"></i>
            </button>
            <button id="footer-favorites-btn" class="footer-btn">
                <i class="fa fa-star"></i>
            </button>
        </footer>

        <!-- Toggle View Button (Floating) -->
        <button id="toggle-view-btn-main" class="footer-btn" style="position: absolute; z-index: 20; right: 10px; top: 160px; background-color: rgba(10,10,10,0.7); backdrop-filter: blur(3px);">
            <i class="fa fa-image"></i> <!-- Tarot Card Icon -->
        </button>
        
        <!-- Stock Button (Floating) -->
        <button id="footer-stock-btn" class="footer-btn" style="position: absolute; z-index: 20; left: 10px; top: 160px; background-color: rgba(10,10,10,0.7); backdrop-filter: blur(3px);">
            <i class="fa fa-warehouse"></i> <!-- Stock/Warehouse Icon -->
        </button>

    </div> <!-- End #app-container -->

    <!-- Favorites Modal -->
    <div id="favorites-modal" class="modal hidden opacity-0">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Favorites</h2>
                <button id="close-favorites-btn" class="modal-close-btn"><i class="fa fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div id="favorites-list-container">
                    <!-- Favorite items injected here -->
                </div>
                <p id="no-favorites-message" class="hidden">You haven't favorited any items yet. Tap the star on a card to add one.</p>
            </div>
        </div>
    </div>
    
    <!-- Bar Stock Modal -->
    <div id="bar-stock-modal" class="modal hidden opacity-0">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Bar Stock</h2>
                <button id="close-stock-btn" class="modal-close-btn"><i class="fa fa-times"></i></button>
            </div>
            <div id="bar-stock-modal-body" class="modal-body">
                <!-- Bar stock items injected here -->
            </div>
        </div>
    </div>
    
    <!-- Filter Modal -->
    <div id="filter-modal" class="modal hidden opacity-0">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Filter Menu</h2>
                <button id="close-filter-btn" class="modal-close-btn"><i class="fa fa-times"></i></button>
            </div>
            <div id="filter-modal-content" class="modal-body">
                <!-- Category -->
                <div id="filter-group-category" class="filter-group">
                    <h3 class="filter-group-title">Category</h3>
                    <div class="filter-pill-container">
                        <button class="filter-pill" data-category="all">All</button>
                        <button class="filter-pill" data-category="cocktail">Cocktails</button>
                        <button class="filter-pill" data-category="shot">Shots</button>
                        <button class="filter-pill" data-category="mocktail">Mocktails</button>
                    </div>
                </div>
                
                <!-- Main Spirit -->
                <div id="filter-group-spirit" class="filter-group">
                    <h3 class="filter-group-title">Main Spirit</h3>
                    <div class="filter-pill-container">
                        <button class="filter-pill" data-spirit="Vodka">Vodka</button>
                        <button class="filter-pill" data-spirit="Gin">Gin</button>
                        <button class="filter-pill" data-spirit="Rum">Rum</button>
                        <button class="filter-pill" data-spirit="Tequila">Tequila</button>
                        <button class="filter-pill" data-spirit="Whiskey">Whiskey</button>
                        <button class="filter-pill" data-spirit="Brandy">Brandy</button>
                        <button class="filter-pill" data-spirit="Liqueur">Liqueur</button>
                    </div>
                </div>
                
                <!-- Other Filters -->
                <div class="filter-group">
                     <div class="filter-select">
                        <h3 class="filter-group-title">Contains Ingredient</h3>
                        <select id="ingredient-filter-select">
                            <option value="">Any</option>
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div class="filter-toggle">
                        <h3 class="filter-group-title">Show Favorites Only</h3>
                        <label class="switch">
                            <input type="checkbox" id="favorites-filter-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button id="reset-filters-btn" class="modal-btn secondary">Reset</button>
                <button id="apply-filters-btn" class="modal-btn primary">Apply</button>
            </div>
        </div>
    </div>


    <script>
        // --- Global State ---
        let allCocktails = [];
        let barStock = {};
        let allIngredients = new Set();
        let uniqueSpirits = new Set();
        let favorites = { drinks: new Set(), recipes: new Set() };
        let activeFilters = {
            category: 'all', // 'all', 'cocktail', 'shot', 'mocktail'
            spirit: null,     // e.g., 'Vodka'
            ingredient: null, // e.g., 'Lime Juice'
            showFavoritesOnly: false
        };
        let isGlobalTarotView = false;
        
        // --- Constants ---
        const FAVORITES_KEY = 'nomads_favorites_v1';
        const BAR_STOCK_KEY = 'nomads_bar_stock_v1';
        const TAROT_VIEW_KEY = 'nomads_tarot_view_v1';
        
        // --- DOM Elements ---
        const menuGrid = document.getElementById('menu-grid');
        const randomDrinkBtn = document.getElementById('random-drink-btn');
        const favoritesModal = document.getElementById('favorites-modal');
        const barStockModal = document.getElementById('bar-stock-modal');
        const filterModal = document.getElementById('filter-modal');
        
        // --- Cocktail Data Setup ---
        function setupCocktailData() {
            allCocktails = [
                // ... Cocktails ...
                { name: "Mudslide", category: "cocktail", spirit: "Vodka", flavorProfile: "A rich, creamy, and decadent dessert drink with vodka, coffee, and Irish cream.", recipe: ["1oz Ketel One Vodka", "1 oz KahlÃºa", "1 oz Baileys Irish Cream"], story: "We tried to ride through a mudslide. It was a bad idea. This drink is a much better, and cleaner, version of that experience. It's still a bad idea to have five of them, though.", image: "https://raw.githubusercontent.com/aarmax8/Nomads/90ba0d71f42b567f7e9a417fbd74cedfc805201e/thumbnail_IMG_7997.jpg", cardHook: "To the shortcuts that weren't." },
                { name: "Desert Wind", category: "cocktail", spirit: "Whiskey", flavorProfile: "A dry and spiced mix of whiskey, ginger soda, and-orange bitters.", recipe: ["2 oz Four Roses Whiskey", "Fill with Ginger Soda", "2 dashes Orange Bitters"], story: "Named for our club secretary, who can talk for three hours without taking a breath. The drink is dry, spicy, and will leave you speechless. We wish he would try one.", image: "https://github.com/aarmax8/Nomads/blob/5915ae46af9d547d456ba87aa624286b7aeb729a/aadesertwind.jpg?raw=true", cardHook: "For stories that go on too long." },
                { name: "Oracle's Kiss", category: "cocktail", spirit: "Vodka", flavorProfile: "A sweet and floral blend of citrus vodka, elderflower, and cranberry.", recipe: ["1.5 oz Stolichnaya Citros Vodka", "0.5 oz St-Germain", "Fill with Cranberry Juice"], story: "Some lady at a carnival gave our treasurer a 'kiss for good luck.' He woke up three hours later with his wallet gone and a lingering taste of cranberry. We made this to commemorate his gullibility.", image: "https://raw.githubusercontent.com/aarmax8/Nomads/90ba0d71f42b567f7e9a417fbd74cedfc805201e/thumbnail_IMG_8297.jpg", cardHook: "The future is sweet and flowery." }, 
                { name: "The Alchemist", category: "cocktail", spirit: "Gin", flavorProfile: "A bright, complex, and herbaceous cocktail that changes color.", recipe: ["2 oz Empress 1908 Gin", "0.75 oz Lemon Juice", "0.5 oz Simple Syrup", "Top with Tonic Water"], story: "Our mechanic insists he can turn lead into gold. He can't. But he *can* turn a regular G&T into this purple marvel, which is close enough for us. Don't ask him about his 'perpetual motion' engine.", image: "https://raw.githubusercontent.com/aarmax8/Nomads/90ba0d71f42b567f7e9a417fbd74cedfc805201e/thumbnail_IMG_8299.jpg", cardHook: "For projects that are *almost* done." },
                { name: "Nomad's Land", category: "cocktail", spirit: "Tequila", flavorProfile: "A spicy and smoky twist on a margarita, with a hint of sweet pineapple.", recipe: ["2 oz Casamigos Reposado Tequila", "1 oz Pineapple Juice", "0.75 oz Lime Juice", "0.5 oz Ancho Reyes Chile Liqueur", "Garnish: Tajin Rim"], story: "This is what you drink when you're 100 miles from anywhere, the sun's setting, and you've only got a fistful of random ingredients. It's smoky, it's spicy, it's sweet, and it's not half bad.", image: "https://raw.githubusercontent.com/aarmax8/Nomads/90ba0d71f42b567f7e9a417fbd74cedfc805201e/thumbnail_IMG_8303.jpg", cardHook: "Here's to making it work." },
                { name: "Garibaldi", category: "cocktail", spirit: "Liqueur", flavorProfile: "A bittersweet and refreshingly simple classic with Campari and 'fluffy' orange juice.", recipe: ["1.5 oz Campari", "0.25 oz Simple Syrup", "Fill a tall glass with Fresh Orange Juice"], story: "Named for an Italian general who united a nation. We just like it because it's bright red and tastes like sunshine. Perfect for those mornings when you need to unite yourself with the living.", image: "https://raw.githubusercontent.com/aarmax8/Nomads/90ba0d71f42b567f7e9a417fbd74cedfc805201e/thumbnail_IMG_8314.jpg", cardHook: "To simple victories." },
                { name: "Killer Cocktail", category: "cocktail", spirit: "Gin", flavorProfile: "A dangerously smooth and fruity mix of amaretto, gin, and passion fruit.", recipe: ["0.5 oz Amaretto", "1 oz Gin", "0.5 oz Campari", "1 oz Passion Fruit Syrup", "0.5 oz Lemon Juice"], story: "This drink has a body count. It's too easy to drink, tastes like fruit punch, and hits you like a freight train. Our last prospect had three and tried to wrestle a cactus. The cactus won.", image: "https://raw.githubusercontent.com/aarmax8/Nomads/90ba0d71f42b567f7e9a417fbd74cedfc805201e/thumbnail_IMG_8305.jpg", cardHook: "Respect the cactus." },
                { name: "Paradise", category: "cocktail", spirit: "Gin", flavorProfile: "A classic, fruity, and vibrant cocktail with gin and apricot brandy.", recipe: ["2 oz Gin", "1 oz Apricot Brandy", "0.75 oz Orange Juice", "0.5 oz Lemon Juice", "Garnish: Cherry"], story: "We found a map to 'Paradise.' After three days of riding, it turned out to be a gas station with a broken ice machine. This drink is what we *wish* we'd found. A true oasis.", image: "https://raw.githubusercontent.com/aarmax8/Nomads/90ba0d71f42b567f7e9a417fbd74cedfc805201e/thumbnail_IMG_8308.jpg", cardHook: "To finding your own oasis." },
                { name: "Statesman", category: "cocktail", spirit: "Whiskey", flavorProfile: "A sophisticated and tart sipper, balancing bourbon with sweet apricot.", recipe: ["2 oz Bourbon", "0.75 oz Apricot Brandy", "0.5 oz Lemon Juice"], story: "This is our president's drink. He says it's 'dignified.' We think it's because he likes to feel fancy while telling us our bikes are too loud. A smooth talker, just like the drink.", image: "https://raw.githubusercontent.com/aarmax8/Nomads/90ba0d71f42b567f7e9a417fbd74cedfc805201e/thumbnail_IMG_8309.jpg", cardHook: "For when you need to be 'dignified'." },
                { name: "The Mechanic", category: "shot", spirit: "Liqueur", flavorProfile: "A quick and dirty shot that's surprisingly complex. Tastes like liquid metal.", recipe: ["0.5 oz KahlÃºa", "0.5 oz Baileys Irish Cream", "0.5 oz Jameson Irish Whiskey"], story: "This is for when you've got 5 minutes to fix a flat and 10 seconds to get right. It's layered, it's tough, and it gets the job done. Just like our mechanic. Mostly.", image: "https://raw.githubusercontent.com/aarmax8/Nomads/90ba0d71f42b567f7e9a417fbd74cedfc805201e/thumbnail_IMG_8310.jpg", cardHook: "Grease, whiskey, and poor choices." },
                { name: "Road Rash", category: "shot", spirit: "Liqueur", flavorProfile: "A sharp, stinging shot of cinnamon whiskey and cranberry. It burns.", recipe: ["1 oz Fireball Cinnamon Whisky", "Splash of Cranberry Juice"], story: "We've all been there. This shot feels about the same as sliding 20 feet on asphalt. It stings, you'll regret it, and you'll probably do it again.", image: "https://raw.githubusercontent.com/aarmax8/Nomads/90ba0d71f42b567f7e9a417fbd74cedfc805201e/thumbnail_IMG_8312.jpg", cardHook: "To learning the hard way." },
                { name: "The Hitchhiker", category: "mocktail", spirit: "N/A", flavorProfile: "A refreshing and harmless mix of lemonade, soda, and a hint of mint.", recipe: ["Fill with Lemonade", "Top with Club Soda", "Splash of Grenadine", "Garnish: Mint Sprig"], story: "Our designated drivers get this one. It looks fancy, tastes great, and keeps you sharp enough to remember where we parked the bikes. Someone has to be the responsible one.", image: "https://raw.githubusercontent.com/aarmax8/Nomads/90ba0d71f42b567f7e9a417fbd74cedfc805201e/thumbnail_IMG_8313.jpg", cardHook: "For the long road home." }
            ];

            // Process ingredients and spirits
            allCocktails.forEach(cocktail => {
                if (cocktail.spirit && cocktail.spirit !== 'N/A') {
                    uniqueSpirits.add(cocktail.spirit);
                }
                cocktail.recipe.forEach(ingStr => {
                    const ingredientName = parseIngredientName(ingStr);
                    if (ingredientName) {
                        allIngredients.add(ingredientName);
                    }
                });
            });
        }
        
        // --- Bar Stock ---
        function initializeBarStock() {
            const savedStock = localStorage.getItem(BAR_STOCK_KEY);
            if (savedStock) {
                barStock = JSON.parse(savedStock);
            } else {
                // Default stock (optional)
                barStock = {};
            }
        }

        function saveBarStock() {
            localStorage.setItem(BAR_STOCK_KEY, JSON.stringify(barStock));
        }

        function toggleBarStock(ingredientName) {
            if (barStock[ingredientName]) {
                delete barStock[ingredientName];
            } else {
                barStock[ingredientName] = true;
            }
            saveBarStock();
            // Re-render the modal body to reflect the change
            renderBarStockModal();
            // Re-render the main grid to update "can make" status
            applyAndRenderFilters();
        }
        
        function renderBarStockModal() {
            const modalBody = document.getElementById('bar-stock-modal-body');
            if (!modalBody) return;

            const categorizedIngredients = {
                spirits: new Set(),
                liqueurs: new Set(),
                mixers: new Set(),
                other: new Set()
            };

            const liqueurList = ['Amaretto', 'KahlÃºa', 'Baileys Irish Cream', 'St-Germain', 'Ancho Reyes Chile Liqueur', 'Campari', 'Apricot Brandy', 'Fireball Cinnamon Whisky'];
            const spiritList = Array.from(uniqueSpirits);
            const mixerList = ['Ginger Soda', 'Cranberry Juice', 'Tonic Water', 'Pineapple Juice', 'Orange Juice', 'Club Soda', 'Lemonade'];

            allIngredients.forEach(ing => {
                if (spiritList.includes(ing) || spiritList.some(s => ing.includes(s))) {
                    categorizedIngredients.spirits.add(ing);
                } else if (liqueurList.includes(ing) || liqueurList.some(l => ing.includes(l))) {
                    categorizedIngredients.liqueurs.add(ing);
                } else if (mixerList.includes(ing) || mixerList.some(m => ing.includes(m))) {
                    categorizedIngredients.mixers.add(ing);
                } else {
                    categorizedIngredients.other.add(ing);
                }
            });

            const createCategoryHTML = (title, ingredients) => {
                if (ingredients.size === 0) return '';
                const itemsHTML = Array.from(ingredients).sort().map(ing => `
                    <div class="stock-item ${barStock[ing] ? 'is-owned' : ''}" data-ingredient="${ing}">
                        ${ing}
                    </div>
                `).join('');
                return `
                    <div class="stock-category">
                        <h3 class="stock-category-title">${title}</h3>
                        <div class="stock-grid">
                            ${itemsHTML}
                        </div>
                    </div>
                `;
            };

            modalBody.innerHTML = `
                ${createCategoryHTML('Spirits', categorizedIngredients.spirits)}
                ${createCategoryHTML('Liqueurs', categorizedIngredients.liqueurs)}
                ${createCategoryHTML('Mixers & Juices', categorizedIngredients.mixers)}
                ${createCategoryHTML('Other', categorizedIngredients.other)}
            `;
            
            // Add event listeners
            modalBody.querySelectorAll('.stock-item').forEach(item => {
                item.addEventListener('click', () => {
                    toggleBarStock(item.dataset.ingredient);
                });
            });
        }
        
        function checkCanMake(cocktail) {
            if (!cocktail.recipe) return false;
            for (const ingStr of cocktail.recipe) {
                const ingredientName = parseIngredientName(ingStr);
                if (ingredientName && !barStock[ingredientName]) {
                    // We are missing at least one ingredient
                    return false;
                }
            }
            // If we get here, we have all ingredients
            return true;
        }

        // --- Favorites ---
        function initializeFavorites() {
            const savedFavorites = localStorage.getItem(FAVORITES_KEY);
            if (savedFavorites) {
                const parsed = JSON.parse(savedFavorites);
                favorites.drinks = new Set(parsed.drinks || []);
                favorites.recipes = new Set(parsed.recipes || []);
            }
            updateFavoritesButtonState();
        }

        function saveFavorites() {
            localStorage.setItem(FAVORITES_KEY, JSON.stringify({
                drinks: Array.from(favorites.drinks),
                recipes: Array.from(favorites.recipes)
            }));
            updateFavoritesButtonState();
        }

        function toggleFavorite(cardName, type, buttonEl) {
            const favSet = type === 'drink' ? favorites.drinks : favorites.recipes;
            let isFavorite = false;

            if (favSet.has(cardName)) {
                favSet.delete(cardName);
                isFavorite = false;
            } else {
                favSet.add(cardName);
                isFavorite = true;
            }
            
            saveFavorites();

            // Update button visual state
            if (buttonEl) {
                buttonEl.classList.toggle('is-favorite', isFavorite);
            }
            
            // Update filter if favorites-only is on
            if (activeFilters.showFavoritesOnly) {
                applyAndRenderFilters();
            }
        }
        
        function renderFavoritesModal() {
            const container = document.getElementById('favorites-list-container');
            const noFavsMsg = document.getElementById('no-favorites-message');
            if (!container || !noFavsMsg) return;
            
            container.innerHTML = ''; // Clear list
            let hasFavorites = false;

            const allFavoriteNames = new Set([...favorites.drinks, ...favorites.recipes]);
            
            if (allFavoriteNames.size === 0) {
                noFavsMsg.classList.remove('hidden');
                return;
            }
            
            noFavsMsg.classList.add('hidden');
            
            Array.from(allFavoriteNames).sort().forEach(cardName => {
                const isDrinkFav = favorites.drinks.has(cardName);
                const isRecipeFav = favorites.recipes.has(cardName);

                if (isDrinkFav) {
                    container.innerHTML += `
                        <div class="favorite-item" data-name="${cardName}" data-view="drink">
                            <i class="favorite-item-icon fa fa-image"></i>
                            <span class="favorite-item-name">${cardName}</span>
                            <span class="favorite-item-view">(Card)</span>
                        </div>
                    `;
                }
                if (isRecipeFav) {
                     container.innerHTML += `
                        <div class="favorite-item" data-name="${cardName}" data-view="recipe">
                            <i class="favorite-item-icon fa fa-file-text"></i>
                            <span class="favorite-item-name">${cardName}</span>
                            <span class="favorite-item-view">(Recipe)</span>
                        </div>
                    `;
                }
            });
        }
        
        function updateFavoritesButtonState() {
             const favBtn = document.getElementById('footer-favorites-btn');
             if (favBtn) {
                 const hasFavorites = favorites.drinks.size > 0 || favorites.recipes.size > 0;
                 favBtn.classList.toggle('is-active', hasFavorites);
             }
        }
        
        // --- Filtering Logic ---
        function initializeFilterModal() {
            // Populate ingredient select
            const selectEl = document.getElementById('ingredient-filter-select');
            if (!selectEl) return;
            
            const sortedIngredients = Array.from(allIngredients).sort();
            sortedIngredients.forEach(ing => {
                const option = document.createElement('option');
                option.value = ing;
                option.textContent = ing;
                selectEl.appendChild(option);
            });
        }
        
        function applyAndRenderFilters() {
            let filteredCocktails = [...allCocktails];

            // 1. Category Filter
            if (activeFilters.category !== 'all') {
                filteredCocktails = filteredCocktails.filter(c => c.category === activeFilters.category);
            }

            // 2. Spirit Filter
            if (activeFilters.spirit) {
                filteredCocktails = filteredCocktails.filter(c => c.spirit === activeFilters.spirit);
            }

            // 3. Ingredient Filter
            if (activeFilters.ingredient) {
                filteredCocktails = filteredCocktails.filter(c => 
                    c.recipe.some(r => parseIngredientName(r) === activeFilters.ingredient)
                );
            }

            // 4. Favorites Filter
            if (activeFilters.showFavoritesOnly) {
                filteredCocktails = filteredCocktails.filter(c => 
                    favorites.drinks.has(c.name) || favorites.recipes.has(c.name)
                );
            }
            
            renderMenuGrid(filteredCocktails);
            updateFilterMenuButtonState();
        }

        function updatePillsFromState() {
            // Update Category
            document.querySelectorAll('#filter-group-category .filter-pill').forEach(p => {
                p.classList.toggle('is-active', p.dataset.category === activeFilters.category);
            });
            // Update Spirit
            document.querySelectorAll('#filter-group-spirit .filter-pill').forEach(p => {
                p.classList.toggle('is-active', p.dataset.spirit === activeFilters.spirit);
            });
            // Update Ingredient
            document.getElementById('ingredient-filter-select').value = activeFilters.ingredient || '';
            // Update Favorites Toggle
            document.getElementById('favorites-filter-toggle').checked = activeFilters.showFavoritesOnly;
        }

        function updateFilterMenuButtonState() {
            const filterBtn = document.getElementById('footer-filters-btn');
            if (!filterBtn) return;
            
            const isDefault = activeFilters.category === 'all' &&
                              !activeFilters.spirit &&
                              !activeFilters.ingredient &&
                              !activeFilters.showFavoritesOnly;
                              
            filterBtn.classList.toggle('is-active', !isDefault);
        }

        // --- UI Rendering ---
        function renderMenuGrid(cocktailsToRender) {
            menuGrid.innerHTML = ''; // Clear existing cards
            
            if (cocktailsToRender.length === 0) {
                menuGrid.innerHTML = `
                    <div style="height: 70vh; display: flex; align-items: center; justify-content: center; text-align: center; padding: 2rem;" class="drink-card">
                        <div class_="card-content">
                            <h2 class="card-title" style="font-size: 1.5rem;">No Drinks Found</h2>
                            <p class="card-hook" style="border: none;">Try adjusting your filters or resetting them.</p>
                        </div>
                    </div>
                `;
                return;
            }

            cocktailsToRender.forEach((cocktail, index) => {
                const card = createDrinkCard(cocktail, index);
                menuGrid.appendChild(card);
            });
            
            // Add Barcode Card at the end
            menuGrid.appendChild(createBarcodeCard());

            // Set initial view
            setCardView(isGlobalTarotView, false); // false = don't save
            
            // Set initial active card
            setTimeout(updateActiveCard, 50);
        }
        
        function createDrinkCard(cocktail, index) {
            const cardEl = document.createElement('div');
            cardEl.className = 'drink-card';
            cardEl.dataset.name = cocktail.name;
            cardEl.dataset.index = index;
            
            const isDrinkFavorite = favorites.drinks.has(cocktail.name);
            const isRecipeFavorite = favorites.recipes.has(cocktail.name);
            const canMake = checkCanMake(cocktail);
            
            let canMakeIndicator = '';
            if (canMake) {
                canMakeIndicator = '<i class="fa fa-check-circle" style="color: #4CAF50; margin-left: 10px;" title="You have all ingredients"></i>';
            }

            cardEl.innerHTML = `
                <div class="drink-card-inner">
                    <!-- Front Face -->
                    <div class="drink-card-face drink-card-front">
                        <button class="favorite-btn ${isDrinkFavorite ? 'is-favorite' : ''}" data-type="drink" aria-label="Favorite Drink">
                            <i class="fa fa-star-o"></i><i class="fa fa-star"></i>
                        </button>
                        <div class="card-image-container">
                            <img class="card-image" src="${cocktail.image}" alt="${cocktail.name}" loading="lazy" onerror="this.src='https://placehold.co/400x300/110e0a/5a4a3a?text=Nomad%27s'">
                        </div>
                        <div class="card-content">
                            <h2 class="card-title">${cocktail.name} ${canMakeIndicator}</h2>
                            <p class="card-hook">${cocktail.cardHook}</p>
                            <p class="card-flavor-profile">${cocktail.flavorProfile}</p>
                        </div>
                    </div>
                    
                    <!-- Back Face -->
                    <div class="drink-card-face drink-card-back">
                         <button class="favorite-btn ${isRecipeFavorite ? 'is-favorite' : ''}" data-type="recipe" aria-label="Favorite Recipe">
                            <i class="fa fa-star-o"></i><i class="fa fa-star"></i>
                        </button>
                        <div class="card-content card-content-back">
                            <h3 class="card-back-title">Recipe</h3>
                            <ul class="card-recipe">
                                ${cocktail.recipe.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                            <p class="card-story">${cocktail.story}</p>
                        </div>
                    </div>
                </div>
            `;
            return cardEl;
        }

        function createBarcodeCard() {
            const cardEl = document.createElement('div');
            cardEl.className = 'drink-card';
            cardEl.dataset.isBarcode = 'true';
            cardEl.innerHTML = `
                <div class="drink-card-inner">
                    <div class="drink-card-face drink-card-front barcode-card-face">
                        <div>
                             <img id="barcode-image" src="https://raw.githubusercontent.com/aarmax8/Nomads/5915ae46af9d547d456ba87aa624286b7aeb729a/barcode.png" alt="DILLIGAF Barcode">
                             <p id="barcode-text">"Does It Look Like I Give A F..."</p>
                        </div>
                    </div>
                    <!-- Back of barcode card (can be same or different) -->
                    <div class="drink-card-face drink-card-back barcode-card-face">
                         <div>
                             <img id="barcode-image" src="https://raw.githubusercontent.com/aarmax8/Nomads/5915ae46af9d547d456ba87aa624286b7aeb729a/barcode.png" alt="DILLIGAF Barcode">
                             <p id="barcode-text">Scan at the bar. Or don't. See if I care.</p>
                        </div>
                    </div>
                </div>
            `;
            return cardEl;
        }
        
        function updateActiveCard() {
            const containerRect = menuGrid.parentElement.getBoundingClientRect();
            const containerCenterY = containerRect.top + containerRect.height / 2;

            let closestCard = null;
            let minDistance = Infinity;

            menuGrid.querySelectorAll('.drink-card').forEach(card => {
                const cardRect = card.getBoundingClientRect();
                const cardCenterY = cardRect.top + cardRect.height / 2;
                const distance = Math.abs(containerCenterY - cardCenterY);

                if (distance < minDistance) {
                    minDistance = distance;
                    closestCard = card;
                }
                
                // Remove active class from all cards first
                card.classList.remove('is-active');
            });

            // Add active class to the closest card
            if (closestCard) {
                closestCard.classList.add('is-active');
            }
        }
        
        function highlightAndScrollToCard(cardEl) {
            if (!cardEl) return;
            
            // Remove active class from all
            menuGrid.querySelectorAll('.drink-card').forEach(card => card.classList.remove('is-active'));
            
            // Add to target
            cardEl.classList.add('is-active');
            
            // Scroll to it
            cardEl.scrollIntoView({
                behavior: 'smooth',
                block: 'center',
                inline: 'center'
            });
        }
        
        function setCardView(isTarot, save = true) {
             isGlobalTarotView = isTarot;
             const icon = document.querySelector('#toggle-view-btn-main i');
             
             document.querySelectorAll('.drink-card').forEach(card => {
                 card.classList.toggle('tarot-view', isTarot);
             });
             
             if (icon) {
                 icon.className = isTarot ? 'fa fa-id-card' : 'fa fa-image'; // Toggle icon
             }
             
             if (save) {
                 localStorage.setItem(TAROT_VIEW_KEY, isTarot);
             }
        }
        
        
        // --- Helper Functions ---
        
        function throttle(func, limit) {
          let lastFunc;
          let lastRan;
          return function(...args) {
            const context = this;
            if (!lastRan) {
              func.apply(context, args);
              lastRan = Date.now();
            } else {
              clearTimeout(lastFunc);
              lastFunc = setTimeout(function() {
                if ((Date.now() - lastRan) >= limit) {
                  func.apply(context, args);
                  lastRan = Date.now();
                }
              }, limit - (Date.now() - lastRan));
            }
          }
        }

        function parseIngredientName(ingStr) {
            let name = ingStr.replace(/^[\d./\s-]+(oz|dashes|dash|garnish)\s*/i, '');
            const instructionalPhrases = [ 'Fill a tall glass with ', 'Fill with ', 'Top with ', 'Splash of ', 'Splash '];
            for (const phrase of instructionalPhrases) {
                if (name.toLowerCase().startsWith(phrase.toLowerCase())) {
                    name = name.substring(phrase.length);
                    const inIndex = name.toLowerCase().indexOf(' in a');
                    if (inIndex > -1) name = name.substring(0, inIndex);
                    break;
                }
            }
            const pureInstructions = ['serve on the rocks'];
            if(pureInstructions.includes(name.toLowerCase().trim())) return null;
            return name.trim();
        }
        
        // --- END HELPER FUNCTIONS ---
 
        let scrollTimeout; // Used for debouncing the scroll event

        document.addEventListener('DOMContentLoaded', () => {
            setupCocktailData();
            initializeFavorites();
            initializeBarStock();
            initializeFilterModal(); 
            applyAndRenderFilters(); 
            updateFilterMenuButtonState(); 
            
            // --- Splash Screen ---
            const splashScreen = document.getElementById('splash-screen');
            const splashSeenKey = 'nomads_splash_seen_v1';
            
            if (splashScreen) {
                if (sessionStorage.getItem(splashSeenKey) === 'true') {
                    splashScreen.style.transition = 'none'; 
                    splashScreen.classList.add('is-hidden');
                } else {
                    splashScreen.addEventListener('click', () => {
                        splashScreen.classList.add('is-hidden');
                        sessionStorage.setItem(splashSeenKey, 'true');
                    }, { once: true }); 
                }
            }

            // --- Menu Grid Events ---
            menuGrid.addEventListener('click', e => {
                const favoriteButton = e.target.closest('.favorite-btn');
                if (favoriteButton) {
                    e.stopPropagation(); 
                    const cardName = e.target.closest('.drink-card').dataset.name;
                    toggleFavorite(cardName, favoriteButton.dataset.type, favoriteButton);
                    return;
                }

                const cardInner = e.target.closest('.drink-card-inner');
                 if (cardInner) {
                      const card = cardInner.closest('.drink-card');
                      if(card && !card.dataset.isBarcode) {
                         card.classList.toggle('is-flipped');
                      }
                 }
            });
 
             // --- Active Card on Scroll ---
            // We use a "debounce" pattern here. The updateActiveCard function will
            // only be called 150ms *after* the user has stopped scrolling.
            // This prevents the "active" class change (and its box-shadow) 
            // from interfering with the browser's scroll-snap behavior.
            menuGrid.parentElement.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(updateActiveCard, 150);
            });
            
            // --- Modal Open/Close Logic ---
            function closeModal(modalElement) {
                if (!modalElement) return;
                modalElement.classList.add('opacity-0');
                setTimeout(() => {
                    modalElement.classList.add('hidden');
                }, 300); 
            }

            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal);
                    }
                });
            });

            // Favorites Modal Close & Item Click
            document.getElementById('close-favorites-btn')?.addEventListener('click', () => closeModal(favoritesModal));
            document.getElementById('favorites-list-container').addEventListener('click', (e) => {
                 const favoriteItem = e.target.closest('.favorite-item');
                 if (favoriteItem) {
                     const cardName = favoriteItem.dataset.name;
                     const cardEl = document.querySelector(`.drink-card[data-name="${cardName}"]`);
                     if (cardEl) {
                         if (favoriteItem.dataset.view === 'drink') {
                             cardEl.classList.remove('is-flipped');
                         }
                         highlightAndScrollToCard(cardEl);
                     }
                     closeModal(favoritesModal);
                 }
            });

            // Bar Stock Modal Close
            document.getElementById('close-stock-btn')?.addEventListener('click', () => closeModal(barStockModal));

            // Filter Modal Close & Actions
            document.getElementById('close-filter-btn')?.addEventListener('click', () => closeModal(filterModal));
            document.getElementById('apply-filters-btn')?.addEventListener('click', () => {
                applyAndRenderFilters();
                closeModal(filterModal);
            });
            document.getElementById('reset-filters-btn')?.addEventListener('click', () => {
                activeFilters = { category: 'all', spirit: null, ingredient: null, showFavoritesOnly: false };
                updatePillsFromState();
                applyAndRenderFilters();
            });
            
            // Filter Modal Content Interactions
            document.getElementById('filter-modal-content').addEventListener('click', (e) => {
                const pill = e.target.closest('.filter-pill');
                if (!pill) return;
                const categoryGroup = e.target.closest('#filter-group-category');
                const spiritGroup = e.target.closest('#filter-group-spirit');
                if (categoryGroup) {
                    activeFilters.category = pill.dataset.category;
                    categoryGroup.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('is-active'));
                    pill.classList.add('is-active');
                } else if (spiritGroup) {
                    const spirit = pill.dataset.spirit;
                    if (activeFilters.spirit === spirit) {
                        activeFilters.spirit = null;
                        pill.classList.remove('is-active');
                    } else {
                        activeFilters.spirit = spirit;
                        spiritGroup.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('is-active'));
                        pill.classList.add('is-active');
                    }
                }
            });
            document.getElementById('ingredient-filter-select')?.addEventListener('change', (e) => {
                 activeFilters.ingredient = e.target.value || null;
            });
            document.getElementById('favorites-filter-toggle')?.addEventListener('change', (e) => {
                activeFilters.showFavoritesOnly = e.target.checked;
            });


            // --- New Footer Button Listeners ---
            document.getElementById('footer-filters-btn')?.addEventListener('click', () => {
                updatePillsFromState(); 
                filterModal.classList.remove('hidden');
                setTimeout(() => filterModal.classList.remove('opacity-0'), 10);
            });
            
            document.getElementById('footer-favorites-btn')?.addEventListener('click', () => {
                renderFavoritesModal(); 
                favoritesModal.classList.remove('hidden');
                setTimeout(() => favoritesModal.classList.remove('opacity-0'), 10);
            });
            
            document.getElementById('footer-stock-btn')?.addEventListener('click', () => {
                renderBarStockModal(); // Render content before showing
                barStockModal.classList.remove('hidden');
                setTimeout(() => barStockModal.classList.remove('opacity-0'), 10);
            });

            // --- Footer Buttons (existing) ---
            if (randomDrinkBtn) {
                randomDrinkBtn.addEventListener('click', () => {
                    const allDrinkCards = document.querySelectorAll('.drink-card:not([data-is-barcode="true"])');
                    if (allDrinkCards.length === 0) return; 
                    const randomIndex = Math.floor(Math.random() * allDrinkCards.length);
                    const randomCard = allDrinkCards[randomIndex];
                    randomCard.classList.remove('is-flipped'); 
                    highlightAndScrollToCard(randomCard);
                });
            }
            
            const scrollPrevBtn = document.getElementById('scroll-prev-btn');
            if (scrollPrevBtn) {
                scrollPrevBtn.addEventListener('click', () => {
                    const cards = Array.from(menuGrid.querySelectorAll('.drink-card'));
                    if (cards.length === 0) return;
                    const activeCard = menuGrid.querySelector('.drink-card.is-active') || cards[0];
                    const activeIndex = cards.indexOf(activeCard);
                    const targetIndex = Math.max(0, activeIndex - 1); // Go up by one card
                    if (activeIndex !== targetIndex) {
                        cards[targetIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    }
                });
            }

            const scrollNextBtn = document.getElementById('scroll-next-btn');
            if (scrollNextBtn) {
                scrollNextBtn.addEventListener('click', () => {
                    const cards = Array.from(menuGrid.querySelectorAll('.drink-card'));
                    if (cards.length === 0) return;
                    const activeCard = menuGrid.querySelector('.drink-card.is-active') || cards[0];
                    const activeIndex = cards.indexOf(activeCard);
                    const targetIndex = Math.min(cards.length - 1, activeIndex + 1); // Go down by one card
                    if (activeIndex !== targetIndex) {
                        cards[targetIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    }
                });
            }
            
            // --- Tarot View Toggle ---
            const savedView = localStorage.getItem(TAROT_VIEW_KEY);
            if (savedView === 'true') {
                setCardView(true, false); // Don't re-save
            }
            
            const toggleViewBtnMain = document.getElementById('toggle-view-btn-main');
            const throttledToggle = throttle(() => {
                 setCardView(!isGlobalTarotView); 
            }, 300); 
            if (toggleViewBtnMain) {
                toggleViewBtnMain.addEventListener('click', throttledToggle);
            }

        }); // End DOMContentLoaded
 
    </script>
</body>
</html>

